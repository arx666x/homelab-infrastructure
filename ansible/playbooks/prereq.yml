---
# ansible/playbooks/prereq.yml
- name: Prepare all nodes for k3s and Longhorn
  hosts: k3s_cluster
  become: true
  gather_facts: true
  
  tasks:
    - name: Set timezone
      timezone:
        name: "{{ timezone }}"
    
    - name: Set hostname
      hostname:
        name: "{{ hostname }}"
    
    - name: Update /etc/hosts with hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ hostname }}"
        state: present
    
    - name: Add node to /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ ansible_host }} {{ hostname }}"
        state: present
    
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
    
    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - iotop
          - nfs-common
          - open-iscsi
          - util-linux
          - cryptsetup
          - jq
          - net-tools
          - python3
          - python3-pip
          - vlan
        state: present
    
    - name: Enable and start iscsid
      systemd:
        name: iscsid
        enabled: true
        state: started
    
    # WICHTIG: Kernel Module ZUERST laden
    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter
        - iscsi_tcp
        - nfs
      ignore_errors: yes
    
    - name: Ensure kernel modules load on boot
      copy:
        content: |
          overlay
          br_netfilter
          iscsi_tcp
          nfs
        dest: /etc/modules-load.d/k8s.conf
        mode: '0644'
    
    # Warte kurz damit Module geladen sind
    - name: Wait for kernel modules
      pause:
        seconds: 2
    
    # Jetzt erst sysctl konfigurieren
    - name: Configure sysctl for Kubernetes
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/k8s.conf
        reload: yes
        ignoreerrors: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }
        - { key: 'fs.inotify.max_user_watches', value: '524288' }
        - { key: 'fs.inotify.max_user_instances', value: '512' }
    
    - name: Disable swap
      shell: swapoff -a
      when: ansible_facts['swaptotal_mb'] > 0
      changed_when: false
    
    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '\sswap\s'
        state: absent
    
    # FÃ¼r Raspberry Pi: cgroup aktivieren
    - name: Enable cgroup on Raspberry Pi
      lineinfile:
        path: /boot/firmware/cmdline.txt
        regexp: '^(.*rootwait.*)$'
        line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
        backrefs: yes
      when: "'worker' in group_names"
      notify: reboot required
      ignore_errors: yes
    
    - name: Test NFS connectivity to Synology
      command: showmount -e {{ nfs_server }}
      register: nfs_test
      changed_when: false
      failed_when: false
    
    - name: Display NFS exports
      debug:
        msg: "NFS server accessible: {{ nfs_test.stdout_lines }}"
      when: nfs_test.rc == 0
    
    - name: Warn if NFS not accessible
      debug:
        msg: "WARNING: Cannot reach NFS server at {{ nfs_server }}"
      when: nfs_test.rc != 0
    
    - name: Display node preparation summary
      debug:
        msg:
          - "Node: {{ hostname }}"
          - "Inventory: {{ inventory_hostname }}"
          - "K8s IP: {{ ansible_host }}"
          - "Mgmt IP: {{ mgmt_ip }}"
          - "Type: {{ 'Master' if k3s_control_node else 'Worker' }}"
  
  handlers:
    - name: reboot required
      debug:
        msg: "Reboot required for cgroup changes on Raspberry Pi"

