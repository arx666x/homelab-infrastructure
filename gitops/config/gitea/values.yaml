# =============================================================================
# Gitea Helm Values - SERI Homelab
# Chart: gitea/gitea v12.4.0  →  Gitea 1.25.x
# https://gitea.com/gitea/helm-gitea
#
# PostgreSQL: Externes StatefulSet (gitops/config/gitea/postgresql/)
#             Offizielles docker.io/library/postgres:16-alpine Image
#             Kein Bitnami-Subchart, kein bitnamilegacy
#
# Änderungen gegenüber v10.6.x:
#   - postgresql: Subchart deaktiviert → externes StatefulSet
#   - redis: → valkey: (Valkey 8.x, bitnami/valkey noch frei verfügbar)
#   - Connection-Strings: gitea-redis-master → gitea-valkey-master
#   - Actions ausgelagert in separates helm-actions Chart (nicht enthalten)
# =============================================================================

gitea:
  admin:
    existingSecret: gitea-admin-secret
    existingSecretKey:
      username: username
      password: password
      email: email

  config:
    server:
      DOMAIN: gitea.reckeweg.io
      ROOT_URL: https://gitea.reckeweg.io
      SSH_DOMAIN: gitea.reckeweg.io
      SSH_PORT: 22
      SSH_LISTEN_PORT: 22
      LFS_START_SERVER: true

    database:
      DB_TYPE: postgres
      # Service-Name des externen StatefulSets
      HOST: gitea-postgresql:5432
      NAME: gitea
      USER: gitea

    cache:
      ADAPTER: redis
      HOST: redis://:@gitea-valkey-master:6379/0

    session:
      PROVIDER: redis
      PROVIDER_CONFIG: redis://:@gitea-valkey-master:6379/1

    queue:
      TYPE: redis
      CONN_STR: redis://:@gitea-valkey-master:6379/2

    indexer:
      ISSUE_INDEXER_TYPE: bleve
      REPO_INDEXER_ENABLED: true
      REPO_INDEXER_TYPE: bleve

    packages:
      ENABLED: true

    service:
      DISABLE_REGISTRATION: false
      REQUIRE_SIGNIN_VIEW: false

    actions:
      # Actions aktivieren - act-runner wird via separatem helm-actions Chart deployed
      ENABLED: true
      # DEFAULT_ACTIONS_URL: github  →  Fallback für Actions ohne eigenen Mirror
      # Alternativ: https://gitea.reckeweg.io für vollständig self-hosted
      DEFAULT_ACTIONS_URL: github

    log:
      MODE: console
      LEVEL: Info

  # DB-Passwort via Env-Variable
  additionalConfigFromEnvs:
    - name: GITEA__DATABASE__PASSWD
      valueFrom:
        secretKeyRef:
          name: gitea-postgresql-secret
          key: password

# -----------------------------------------------------------------------------
# PostgreSQL Subchart - DEAKTIVIERT
# Wird durch externes StatefulSet ersetzt (gitops/config/gitea/postgresql/)
# -----------------------------------------------------------------------------
postgresql:
  enabled: false

postgresql-ha:
  enabled: false

# -----------------------------------------------------------------------------
# Valkey Subchart
# bitnami/valkey ist noch frei verfügbar (neu genug, nicht von Bitnami-Änderung
# betroffen). Tag gepinnt für Stabilität.
# -----------------------------------------------------------------------------
valkey-cluster:
  enabled: false

valkey:
  enabled: true
  image:
    registry: docker.io
    repository: bitnami/valkey
    tag: "8.0"
  architecture: standalone
  auth:
    enabled: false
  primary:
    persistence:
      enabled: true
      storageClass: longhorn
      size: 2Gi
    resources:
      requests:
        memory: 64Mi
        cpu: 50m
      limits:
        memory: 128Mi
        cpu: 200m

redis-cluster:
  enabled: false

redis:
  enabled: false

# -----------------------------------------------------------------------------
# Persistenz (Gitea Daten: Repos, LFS, Avatare etc.)
# -----------------------------------------------------------------------------
persistence:
  enabled: true
  storageClass: longhorn
  size: 50Gi
  accessModes:
    - ReadWriteOnce
  annotations:
    "helm.sh/resource-policy": keep

# -----------------------------------------------------------------------------
# Ingress via Traefik
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  className: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
    - host: gitea.reckeweg.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: gitea-tls
      hosts:
        - gitea.reckeweg.io

# -----------------------------------------------------------------------------
# Service
# -----------------------------------------------------------------------------
service:
  http:
    type: ClusterIP
    port: 3000
  ssh:
    type: LoadBalancer
    port: 22
    annotations:
      metallb.universe.tf/loadBalancerIPs: "192.168.20.101"

# -----------------------------------------------------------------------------
# Deployment
# -----------------------------------------------------------------------------
replicaCount: 1

resources:
  requests:
    memory: 256Mi
    cpu: 100m
  limits:
    memory: 1Gi
    cpu: 1000m

affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 50
        preference:
          matchExpressions:
            - key: kubernetes.io/arch
              operator: In
              values:
                - amd64
